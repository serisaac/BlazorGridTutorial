@page "/people-grid"

@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.QuickGrid
@using BlazorGridTutorial.Data
@using BlazorGridTutorial.Components
@using Microsoft.EntityFrameworkCore
@inject IJSRuntime JSRuntime
@inject ApplicationDbContext DbContext

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Lista de personas desde la Base de Datos</h3>
    <button class="btn btn-success" @onclick="StartAddPerson">
        <span class="bi bi-plus-circle-fill me-2"></span>Añadir Nueva Persona
    </button>
</div>

@if (people == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <div class="grid-container">
        <QuickGrid Items="@people" Pagination="@pagination">
            <PropertyColumn Property="@(p => p.Id)" Title="ID" Sortable="true" />
            <PropertyColumn Property="@(p => p.FirstName)" Title="Nombre" Sortable="true" />
            <PropertyColumn Property="@(p => p.LastName)" Title="Apellido" Sortable="true" />
            <PropertyColumn Property="@(p => p.BirthDate)" Title="Fecha de Nacimiento" Format="yyyy-MM-dd" />
            <TemplateColumn Title="Acciones">
                <button class="btn btn-sm btn-primary" @onclick="() => StartEditPerson(context)">Editar</button>
                <button class="btn btn-sm btn-danger ms-2" @onclick="() => DeletePerson(context)">Eliminar</button>
            </TemplateColumn>
        </QuickGrid>
        <Paginator State="@pagination" />
    </div>
}

@* El componente del Modal se llama aquí, por separado del grid *@
<EditPersonModal Person="personToEdit" OnSave="SaveChanges" OnCancel="CancelEdit" />

@code {
    private IQueryable<Person>? people;
    private PaginationState pagination = new PaginationState { ItemsPerPage = 3 };
    private Person? personToEdit;

    protected override async Task OnInitializedAsync()
    {
        await LoadGridData();
    }

    // AQUÍ ESTÁ EL MÉTODO QUE FALTABA
    private void StartAddPerson()
    {
        personToEdit = new Person();
    }

    private void StartEditPerson(Person person)
    {
        personToEdit = new Person
        {
            Id = person.Id,
            FirstName = person.FirstName,
            LastName = person.LastName,
            HireDate = person.HireDate,
            BirthDate = person.BirthDate
        };
    }

    private async Task SaveChanges(Person updatedPerson)
    {
        if (updatedPerson.Id == 0)
        {
            updatedPerson.HireDate = DateOnly.FromDateTime(DateTime.Now);
            await DbContext.People.AddAsync(updatedPerson);
        }
        else
        {
            var personInDb = await DbContext.People.FindAsync(updatedPerson.Id);
            if (personInDb != null)
            {
                personInDb.FirstName = updatedPerson.FirstName;
                personInDb.LastName = updatedPerson.LastName;
                personInDb.BirthDate = updatedPerson.BirthDate;
            }
        }
        await DbContext.SaveChangesAsync();
        await LoadGridData();
        personToEdit = null;
    }

    private void CancelEdit()
    {
        personToEdit = null;
    }

    private async Task DeletePerson(Person personToDelete)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Estás seguro de que quieres eliminar a {personToDelete.FirstName} {personToDelete.LastName}?");
        if (confirmed)
        {
            DbContext.People.Remove(personToDelete);
            await DbContext.SaveChangesAsync();
            await LoadGridData();
        }
    }

    private async Task LoadGridData()
    {
        people = DbContext.People.AsQueryable();
        StateHasChanged();
    }
}
